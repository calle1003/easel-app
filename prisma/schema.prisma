// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum SaleStatus {
  NOT_ON_SALE
  ON_SALE
  SOLD_OUT
  ENDED
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum TicketType {
  GENERAL
  RESERVED
  VIP1
  VIP2
}

model Performance {
  id                Int       @id @default(autoincrement())
  title             String
  volume            String?   @db.VarChar(50)
  year              Int?      @map("year")
  isOnSale          Boolean   @default(false) @map("is_on_sale")
  generalPrice      Int       @map("general_price")
  reservedPrice     Int       @map("reserved_price")
  vip1Price         Int?      @map("vip1_price")
  vip2Price         Int?      @map("vip2_price")
  vip1Note          String?   @map("vip1_note") @db.Text
  vip2Note          String?   @map("vip2_note") @db.Text
  flyerImages       Json?     @map("flyer_images")
  description       String?   @db.Text
  painters          Json?     @map("painters")
  choreographers    Json?     @map("choreographers")
  navigators        Json?     @map("navigators")
  guestDancers      Json?     @map("guest_dancers")
  staff             Json?     @map("staff")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime? @updatedAt @map("updated_at")

  sessions          PerformanceSession[]
  performers        PerformancePerformer[]

  @@map("performances")
}

model PerformanceSession {
  id                Int       @id @default(autoincrement())
  performanceId     Int       @map("performance_id")
  showNumber        Int       @map("show_number")
  performanceDate   DateTime  @map("performance_date") @db.Date
  performanceTime   DateTime  @map("performance_time") @db.Time
  doorsOpenTime     DateTime? @map("doors_open_time") @db.Time
  venueName         String    @map("venue_name")
  venueAddress      String?   @map("venue_address")
  venueAccess       String?   @map("venue_access")
  generalCapacity   Int       @map("general_capacity") @default(0)
  reservedCapacity  Int       @map("reserved_capacity") @default(0)
  vip1Capacity      Int       @map("vip1_capacity") @default(0)
  vip2Capacity      Int       @map("vip2_capacity") @default(0)
  generalSold       Int       @map("general_sold") @default(0)
  reservedSold      Int       @map("reserved_sold") @default(0)
  vip1Sold          Int       @map("vip1_sold") @default(0)
  vip2Sold          Int       @map("vip2_sold") @default(0)
  saleStatus        SaleStatus @map("sale_status") @default(NOT_ON_SALE)
  saleStartAt       DateTime? @map("sale_start_at")
  saleEndAt         DateTime? @map("sale_end_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime? @updatedAt @map("updated_at")

  performance       Performance    @relation(fields: [performanceId], references: [id], onDelete: Cascade)
  exchangeCodes     ExchangeCode[]

  @@index([performanceId])
  @@index([saleStatus])
  @@index([performanceDate])
  @@map("performance_sessions")
}

model News {
  id          Int      @id @default(autoincrement())
  title       String
  content     String?  @db.Text
  publishedAt DateTime @map("published_at")
  category    String?

  @@map("news")
}

model AdminUser {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  password   String
  name       String
  role       AdminRole @default(ADMIN)
  createdAt  DateTime  @default(now()) @map("created_at")
  lastLoginAt DateTime? @map("last_login_at")

  @@map("admin_users")
}

model ExchangeCode {
  id                   Int       @id @default(autoincrement())
  code                 String    @unique @db.VarChar(50)
  performerId          Int?      @map("performer_id")
  performerName        String?   @map("performer_name") @db.VarChar(100)
  performanceSessionId Int?      @map("performance_session_id")
  isUsed               Boolean   @default(false) @map("is_used")
  usedAt               DateTime? @map("used_at")
  orderId              Int?      @map("order_id")
  createdAt            DateTime  @default(now()) @map("created_at")

  performer            Performer?          @relation(fields: [performerId], references: [id])
  performanceSession   PerformanceSession? @relation(fields: [performanceSessionId], references: [id])

  @@index([performerId])
  @@index([performanceSessionId])
  @@map("exchange_codes")
}

model Order {
  id                    Int         @id @default(autoincrement())
  stripeSessionId       String?     @unique @map("stripe_session_id")
  stripePaymentIntentId String?     @map("stripe_payment_intent_id")
  performanceDate       String      @map("performance_date") @db.VarChar(50)
  performanceLabel      String?     @map("performance_label") @db.VarChar(100)
  generalQuantity       Int         @default(0) @map("general_quantity")
  reservedQuantity      Int         @default(0) @map("reserved_quantity")
  vip1Quantity          Int         @default(0) @map("vip1_quantity")
  vip2Quantity          Int         @default(0) @map("vip2_quantity")
  generalPrice          Int         @map("general_price")
  reservedPrice         Int         @map("reserved_price")
  vip1Price             Int         @default(0) @map("vip1_price")
  vip2Price             Int         @default(0) @map("vip2_price")
  discountedGeneralCount Int        @default(0) @map("discounted_general_count")
  discountAmount        Int         @default(0) @map("discount_amount")
  exchangeCodes         String?     @map("exchange_codes") @db.VarChar(500)
  totalAmount           Int         @map("total_amount")
  customerName          String      @map("customer_name") @db.VarChar(100)
  customerEmail         String      @map("customer_email")
  customerPhone         String?     @map("customer_phone") @db.VarChar(20)
  status                OrderStatus @default(PENDING)
  createdAt             DateTime    @default(now()) @map("created_at")
  paidAt                DateTime?   @map("paid_at")
  cancelledAt           DateTime?   @map("cancelled_at")

  tickets               Ticket[]

  @@index([stripeSessionId], name: "idx_order_stripe_session")
  @@index([status], name: "idx_order_status")
  @@index([customerEmail], name: "idx_order_customer_email")
  @@index([performanceDate], name: "idx_order_performance_date")
  @@map("orders")
}

model Ticket {
  id          Int        @id @default(autoincrement())
  orderId     Int        @map("order_id")
  ticketCode  String     @unique @map("ticket_code") @db.VarChar(36)
  ticketType  TicketType @map("ticket_type")
  isExchanged Boolean    @default(false) @map("is_exchanged")
  isUsed      Boolean    @default(false) @map("is_used")
  usedAt      DateTime?  @map("used_at")
  createdAt   DateTime   @default(now()) @map("created_at")

  order       Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([ticketCode], name: "idx_ticket_code")
  @@index([orderId], name: "idx_ticket_order")
  @@index([ticketType], name: "idx_ticket_type")
  @@map("tickets")
}

model Performer {
  id            Int       @id @default(autoincrement())
  name          String    @db.VarChar(100)
  nameKana      String?   @map("name_kana") @db.VarChar(100)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime? @updatedAt @map("updated_at")

  performances  PerformancePerformer[]
  exchangeCodes ExchangeCode[]

  @@map("performers")
}

model PerformancePerformer {
  id            Int       @id @default(autoincrement())
  performanceId Int       @map("performance_id")
  performerId   Int       @map("performer_id")
  role          String?   @db.VarChar(50)
  displayOrder  Int       @default(0) @map("display_order")
  createdAt     DateTime  @default(now()) @map("created_at")

  performance   Performance @relation(fields: [performanceId], references: [id], onDelete: Cascade)
  performer     Performer   @relation(fields: [performerId], references: [id], onDelete: Cascade)

  @@unique([performanceId, performerId])
  @@index([performanceId])
  @@index([performerId])
  @@map("performance_performers")
}
